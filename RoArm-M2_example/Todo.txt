================================================================================
RoArm-M2-S 添加第6个舵机 - 任务清单与技术方案
Adding 6th Servo to RoArm-M2-S - Task List & Technical Plan
================================================================================
更新时间 / Updated: 2026-01-20

--------------------------------------------------------------------------------
✅ 任务1：确定舵机连接方式
--------------------------------------------------------------------------------
结论：所有ST3215舵机采用串行总线连接（串联方式）

【硬件拓扑】
ESP32 (GPIO 18 RX, GPIO 19 TX)
    ↓ (1Mbps串行总线)
ID11 → ID12 → ID13 → ID14 → ID15 → [ID16 新增位置]

【通信协议】（参考：https://www.waveshare.com/wiki/ST3215_Servo）
- 波特率：1Mbps (1000000)
- 寻址方式：ID寻址（0-253）
- 理论支持：最多253个舵机同时控制
- 实际应用：5个舵机 → 扩展至6个舵机

【代码验证】
- 文件：RoArm-M2_config.h (第184-186行)
  #define S_RXD 18
  #define S_TXD 19
- 文件：RoArm-M2_module.h (第148行)
  Serial1.begin(1000000, SERIAL_8N1, S_RXD, S_TXD);

状态：✅ 已确认


--------------------------------------------------------------------------------
✅ 任务2：评估新舵机对现有系统的影响
--------------------------------------------------------------------------------
结论：使用"保守方案A"不会影响现有舵机

【方案A：保守方案（推荐）】
策略：前5个舵机同步控制，第6个舵机独立控制

优点：
  ✅ 不修改现有同步控制逻辑
  ✅ 第6个舵机故障不影响机械臂主功能
  ✅ 代码改动最小（仅添加，不修改）
  ✅ 与ST3215官方文档中的单/多舵机混合控制模式一致

技术依据（ST3215 Wiki）：
  - 单舵机控制：st.WritePos(ID, pos, speed, acc)
  - 多舵机同步：st.SyncWritePosEx(IDArray, count, ...)
  - 可混合使用两种控制方式

【方案B：激进方案（不推荐）】
策略：6个舵机全部同步控制
缺点：
  ❌ 需修改多处SyncWritePosEx调用
  ❌ 第6个舵机故障会影响整体初始化
  ❌ 风险较高

决策：采用方案A

状态：✅ 方案已确定


--------------------------------------------------------------------------------
✅ 任务3：确定物理连接位置
--------------------------------------------------------------------------------
连接位置：ID15 (GRIPPER) 舵机的输出端口

【ST3215舵机接口】（每个舵机有2个端口）
  输入端口 (IN)：  ┌─ GND   (黑/棕)
                   ├─ VCC   (红) 12V
                   └─ DATA  (黄/白) 信号线

  输出端口 (OUT)： ┌─ GND   (黑/棕)
                   ├─ VCC   (红) 12V
                   └─ DATA  (黄/白) 信号线

【连接步骤】
1. 找到ID15舵机的输出端口（OUT）
2. 将ID16舵机的输入端口（IN）连接到ID15的OUT
3. 确保ID16舵机连接12V电源
4. 确保GND共地

【预先设置ID16】
⚠️ 重要：新舵机出厂ID=1，必须先改为ID=16！

方法1：使用Web界面（推荐）
  - 单独连接新舵机
  - 访问 192.168.4.1
  - ID: 1 → 16

方法2：使用代码
  st.unLockEprom(1);
  st.writeByte(1, SMS_STS_ID, 16);
  st.LockEprom(16);

状态：✅ 连接方案已确定


--------------------------------------------------------------------------------
⏳ 任务4：代码修改实施方案（待审核）
--------------------------------------------------------------------------------

【修改清单】

文件1：RoArm-M2_config.h
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置：第65行后
修改：添加ID定义
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#define GRIPPER_SERVO_ID 15
#define END_EFFECTOR_SERVO_ID 16  // 新增

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置：第210-218行
修改：数组保持不变（重要！）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
u8  servoID[5] = {11, 12, 13, 14, 15};  // 保持5个
s16 goalPos[5] = {2047, 2047, 2047, 2047, 2047};  // 不变
u16 moveSpd[5] = {0, 0, 0, 0, 0};  // 不变
u8  moveAcc[5] = {...};  // 不变

原因：这些数组用于SyncWritePosEx同步控制前5个舵机
     第6个舵机使用WritePosEx独立控制


文件2：RoArm-M2_module.h
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置：第23行
修改：扩展反馈数组
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ServoFeedback servoFeedback[6];  // 5→6
// [0] BASE_SERVO_ID (11)
// [1] SHOULDER_DRIVING_SERVO_ID (12)
// [2] SHOULDER_DRIVEN_SERVO_ID (13)
// [3] ELBOW_SERVO_ID (14)
// [4] GRIPPER_SERVO_ID (15)
// [5] END_EFFECTOR_SERVO_ID (16)  // 新增

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置：第160行
修改：初始化检查保持不变
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
void RoArmM2_initCheck(bool returnType) {
  RoArmM2_initCheckSucceed = false;
  RoArmM2_initCheckSucceed = getFeedback(BASE_SERVO_ID, true) &&
                             getFeedback(SHOULDER_DRIVING_SERVO_ID, true) &&
                             getFeedback(SHOULDER_DRIVEN_SERVO_ID, true) &&
                             getFeedback(ELBOW_SERVO_ID, true);
  // 注意：不检查ID15和ID16（末端工具可选）
  ...
}

原因：末端工具（夹爪、第6舵机）是可选的，不应影响系统启动

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置：文件末尾（约第1280行）
修改：添加控制函数（新增代码，不修改现有）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 第6个舵机控制函数
// 参考：ST3215 Wiki - WritePos示例
void endEffectorRotate(double angleDegrees, u16 speed, u8 acc) {
  // 位置计算：ST3215分辨率 = 360°/4096 = 0.088°/步
  s16 targetPos = (s16)((angleDegrees / 360.0) * ARM_SERVO_POS_RANGE);
  targetPos = constrain(targetPos, 0, ARM_SERVO_POS_RANGE - 1);

  // 使用WritePosEx单独控制（参考ST3215 Wiki）
  st.WritePosEx(END_EFFECTOR_SERVO_ID, targetPos, speed, acc);

  if(InfoPrint == 1) {
    Serial.print("EndEffector: ");
    Serial.print(angleDegrees);
    Serial.print("° → pos:");
    Serial.println(targetPos);
  }
}

// 快捷函数
void endEffectorRotate0()   { endEffectorRotate(0, 1500, 50); }
void endEffectorRotate90()  { endEffectorRotate(90, 1500, 50); }
void endEffectorRotate180() { endEffectorRotate(180, 1500, 50); }
void endEffectorRotate270() { endEffectorRotate(270, 1500, 50); }
void endEffectorRotate360() { endEffectorRotate(360, 1500, 50); }

// 反馈函数
int endEffectorGetPosition() {
  if(getFeedback(END_EFFECTOR_SERVO_ID, true)) {
    return servoFeedback[END_EFFECTOR_SERVO_ID - 11].pos;
  }
  return -1;
}

double endEffectorPosToDegrees(int pos) {
  return (pos * 360.0) / ARM_SERVO_POS_RANGE;
}


文件3：json_cmd.h
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置：第442行后
修改：添加命令定义
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// End Effector Servo (ID 16) Control
// {"T":700,"angle":90}
// {"T":700,"angle":180,"speed":2000,"acc":100}
#define CMD_END_EFFECTOR_ROTATE 700


文件4：uart_ctrl.h
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置：最后一个case后，switch结束前
修改：添加命令处理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
case CMD_END_EFFECTOR_ROTATE:
  {
    double angle = jsonCmdReceive["angle"] | 0;
    u16 speed = jsonCmdReceive["speed"] | 1500;
    u8 acc = jsonCmdReceive["acc"] | 50;
    endEffectorRotate(angle, speed, acc);
  }
  break;


【技术参数】（基于ST3215规格）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置范围：     0 - 4095 (中位2047)
角度范围：     0° - 360°
位置精度：     0.088°/步 (360°/4096)
速度范围：     0 - 4500 步/秒
推荐速度：     1500 步/秒（约22 RPM）
加速度范围：   0 - 254
推荐加速度：   50
电压：         12V (6-12.6V)
扭矩：         30kg·cm @12V
波特率：       1000000 (1Mbps)


【测试方案】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 硬件连接测试
   - 扫描ID：使用servo_scanner_fixed.ino
   - 预期结果：找到ID 11, 12, 13, 14, 15, 16

2. 单独控制测试
   - JSON命令：{"T":700,"angle":90}
   - 预期结果：ID16舵机旋转到90°

3. 混合控制测试
   - 先控制机械臂：{"T":100}
   - 再控制第6舵机：{"T":700,"angle":180}
   - 预期结果：两者互不影响

4. Python工具测试
   - 运行：python3 roarm_controller_6servo.py
   - 测试菜单选项 [8]-[15]


【风险评估】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
风险等级：🟢 低

修改类型：全部为"添加"，无"修改现有代码"
影响范围：仅影响新增的第6个舵机功能
回退方案：删除新增代码即可恢复原状
兼容性：  与现有5舵机系统完全兼容


状态：⏳ 待用户审核


--------------------------------------------------------------------------------
📋 待讨论问题
--------------------------------------------------------------------------------
1. 第6个舵机的默认速度和加速度参数是否合适？
   - 当前：speed=1500, acc=50
   - 可调范围：speed(0-4500), acc(0-254)

2. 是否需要在初始化时将第6个舵机归零？
   - 建议：不自动归零，由用户手动控制

3. 是否需要添加第6个舵机的扭矩控制？
   - 类似GRIPPER的扭矩控制功能

4. 第6个舵机的位置限制？
   - 当前：0-360°全范围
   - 是否需要限制？


--------------------------------------------------------------------------------
📚 参考资料
--------------------------------------------------------------------------------
- ST3215舵机Wiki：https://www.waveshare.com/wiki/ST3215_Servo
- RoArm-M2 GitHub：https://github.com/waveshareteam/roarm_m2
- 通信协议：1Mbps半双工串行总线，ID寻址


================================================================================
下一步：等待用户审核方案，确认后开始实施
================================================================================
